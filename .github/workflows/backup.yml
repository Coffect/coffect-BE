name: deploy-backup

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Configure SSH for Backup Server
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BACKUP_SERVER_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          cat > ~/.ssh/config << EOF
          Host backup-server
            HostName ${{ secrets.BACKUP_SERVER_HOST }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            PORT 2210
            LogLevel ERROR
          EOF

      - name: Test SSH Connection
        run: ssh backup-server "echo 'âœ… Backup Server SSH Connection Successful'"

      - name: Sync Files to Backup Server
        run: |
          echo "ðŸ“ ë°±ì—… ì„œë²„ë¡œ íŒŒì¼ ë™ê¸°í™” ì¤‘..."
          rsync -avz --progress \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'logs' \
            --exclude 'dist' \
            --exclude '.env' \
            ./ backup-server:/home/ubuntu/coffect-BE-backup/

      - name: Setup Backup Server Directory
        run: |
          ssh backup-server '
            # ë°±ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„
            mkdir -p /home/ubuntu/coffect-BE-backup
            
            # ê¸°ì¡´ .env ë°±ì—…
            if [ -f /home/ubuntu/coffect-BE-backup/.env ]; then
              cp /home/ubuntu/coffect-BE-backup/.env /home/ubuntu/coffect-BE-backup/.env.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
            fi
          '

      - name: Install Dependencies on Backup
        run: |
          ssh backup-server '
            cd /home/ubuntu/coffect-BE-backup
            
            echo "ðŸ“¦ ë°±ì—… ì„œë²„ Dependencies ì„¤ì¹˜ ì¤‘..."
            npm install
            echo "âœ… ë°±ì—… ì„œë²„ Dependencies ì„¤ì¹˜ ì™„ë£Œ"
          '

      - name: Generate Prisma Client on Backup
        run: |
          ssh backup-server '
            cd /home/ubuntu/coffect-BE-backup
            
            echo "ðŸ”§ ë°±ì—… ì„œë²„ Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì¤‘..."
            npx prisma generate --schema=prisma/schema.prisma
            echo "âœ… ë°±ì—… ì„œë²„ Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì™„ë£Œ"
          '

      - name: Fix Source Code Imports on Backup
        run: |
          ssh backup-server '
            cd /home/ubuntu/coffect-BE-backup
            
            echo "ðŸ” ë°±ì—… ì„œë²„ Prisma import ê²½ë¡œ ìˆ˜ì • ì¤‘..."
            
            # íš¨ìœ¨ì ì¸ íŒŒì¼ ìˆ˜ì •
            find src/ -name "*.ts" -type f | while read file; do
              if grep -q "generated/prisma" "$file" 2>/dev/null; then
                echo "ìˆ˜ì •: $file"
                sed -i "s|from [\"'\''].*generated/prisma[\"'\'']|from '\''@prisma/client'\''|g" "$file"
                sed -i "s|require([\"'\''].*generated/prisma[\"'\''])|require('\''@prisma/client'\'')|g" "$file"
              fi
            done
            
            echo "âœ… ë°±ì—… ì„œë²„ Import ê²½ë¡œ ìˆ˜ì • ì™„ë£Œ"
          '

      - name: Create Environment File for Backup
        run: |
          ssh backup-server "cat > /home/ubuntu/coffect-BE-backup/.env << 'EOF'
          DATABASE_NAME=${{ secrets.DATABASE_NAME }}
          DATABASE_Endpoint=${{ secrets.DATABASE_Endpoint }}
          DATABASE_HOST=${{ secrets.DATABASE_HOST }}
          DATABASE_PORT=${{ secrets.DATABASE_PORT }}
          DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
          EC2_PORT=${{ secrets.EC2_PORT }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH=${{ secrets.JWT_REFRESH }}
          S3_ACCESS_KEY=${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY=${{ secrets.S3_SECRET_KEY }}
          S3_NAME=${{ secrets.S3_NAME }}
          ENV=3002
          EOF"

      - name: Build on Backup
        run: |
          ssh backup-server '
            cd /home/ubuntu/coffect-BE-backup
            
            echo "ðŸ—ï¸ ë°±ì—… ì„œë²„ ë¹Œë“œ ì¤‘..."
            npm run build
            echo "âœ… ë°±ì—… ì„œë²„ ë¹Œë“œ ì™„ë£Œ"
          '

      - name: Stop PM2 Process on Backup
        run: |
          ssh backup-server '
            cd /home/ubuntu/coffect-BE-backup
            
            echo "ðŸ›‘ PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘..."
            pm2 stop coffect-backup || true
            pm2 delete coffect-backup || true
            echo "âœ… PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì™„ë£Œ"
          '

      - name: Start PM2 Process on Backup
        run: |
          ssh backup-server '
            cd /home/ubuntu/coffect-BE-backup
            
            echo "ðŸš€ PM2ë¡œ ë°±ì—… ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘ ì¤‘..."
            pm2 start dist/index.js --name coffect-backup
            echo "âœ… PM2 ë°±ì—… í”„ë¡œì„¸ìŠ¤ ì‹œìž‘ ì™„ë£Œ"
          '

      - name: Check PM2 Status
        run: |
          ssh backup-server '
            echo "ðŸ¥ PM2 ìƒíƒœ í™•ì¸..."
            pm2 status
            echo "âœ… ë°±ì—… ì„œë²„ ë°°í¬ ì™„ë£Œ"
          '

      - name: Backup Deployment Summary
        if: always()
        run: |
          echo "ðŸ“Š ë°±ì—… ì„œë²„ ë°°í¬ ì™„ë£Œ"
          echo "============================"
          echo "âœ… ë©”ì¸ ë¸Œëžœì¹˜ ë³€ê²½ì‚¬í•­ì´ ë°±ì—… ì„œë²„ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤"
          echo "âœ… PM2ë¡œ coffect-backup í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ìž…ë‹ˆë‹¤"
          echo "â° ë°°í¬ ì™„ë£Œ: $(date)"
